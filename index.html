<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Website Builder</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* CRITICAL FIX 3: Strict Mobile View Logic */
        body { 
            min-height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            margin: 0;
            background-color: #111827; /* Tailwind gray-900 */
        }
        
        /* Layout logic to support Sidebar (Left) while body is flex-col */
        .app-container {
            display: flex;
            flex-direction: row;
            flex: 1;
            overflow: hidden;
            width: 100%;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Auto-resizing textarea hide scroll if not needed */
        #prompt-input { scrollbar-width: none; }
        #prompt-input::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div class="app-container">
        
        <aside id="sidebar" class="w-64 bg-gray-900 border-r border-gray-700 flex flex-col shrink-0 hidden md:flex absolute md:relative z-40 h-full transition-all">
            <div class="p-4 shrink-0">
                <button onclick="createNewProject()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> New Project
                </button>
            </div>

            <div id="project-list" class="flex-1 overflow-y-auto px-3 py-2 space-y-1">
                </div>

            <div class="p-4 border-t border-gray-700 shrink-0 bg-gray-900">
                <button onclick="toggleSettings(true)" class="w-full flex items-center justify-center text-gray-400 hover:text-white transition py-2 gap-2">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
        </aside>

        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/50 z-30 md:hidden" onclick="toggleSidebar()"></div>

        <main class="flex-1 flex flex-col min-w-0 bg-white relative">
            
            <header class="h-14 bg-gray-900 border-b border-gray-700 flex items-center justify-between px-4 shrink-0">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white text-lg">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="flex space-x-1.5">
                        <div class="w-3.5 h-3.5 rounded-full bg-red-500 shadow-sm"></div>
                        <div class="w-3.5 h-3.5 rounded-full bg-yellow-500 shadow-sm"></div>
                        <div class="w-3.5 h-3.5 rounded-full bg-green-500 shadow-sm"></div>
                    </div>
                </div>

                <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-700">
                    <button id="btn-preview" onclick="switchTab('preview')" class="px-4 py-1.5 rounded-md text-sm font-medium bg-gray-600 text-white shadow transition">Preview</button>
                    <button id="btn-code" onclick="switchTab('code')" class="px-4 py-1.5 rounded-md text-sm font-medium text-gray-400 hover:text-white transition">Code</button>
                </div>

                <button onclick="downloadCode()" class="text-gray-400 hover:text-white transition p-2" title="Download index.html">
                    <i class="fas fa-download text-lg"></i>
                </button>
            </header>

            <div class="flex-1 relative overflow-hidden bg-gray-50">
                
                <div id="loader" class="hidden absolute inset-0 bg-gray-900/80 backdrop-blur-sm z-20 flex flex-col items-center justify-center text-white">
                    <i class="fas fa-circle-notch fa-spin text-5xl text-blue-500 mb-4"></i>
                    <p class="font-medium animate-pulse">Generating your website...</p>
                </div>

                <iframe id="preview-frame" class="w-full h-full border-0 bg-white absolute inset-0 z-10"></iframe>
                
                <textarea id="code-view" class="hidden absolute inset-0 z-10 w-full h-full bg-[#1e1e1e] text-[#d4d4d4] p-4 font-mono text-sm resize-none outline-none" spellcheck="false" oninput="updateFromCode(this.value)"></textarea>
            </div>

            <footer class="shrink-0 border-t border-gray-700 bg-gray-900 p-3 pb-safe">
                <div class="max-w-4xl mx-auto flex items-end gap-2 bg-gray-800 rounded-xl p-2 border border-gray-700 focus-within:border-blue-500 transition-colors shadow-inner">
                    <textarea 
                        id="prompt-input" 
                        rows="1" 
                        class="flex-1 bg-transparent text-white outline-none resize-none max-h-32 min-h-[44px] py-2.5 px-3" 
                        placeholder="Describe the website layout and style..."
                        oninput="autoResize(this)"
                        onkeydown="handleEnter(event)"
                    ></textarea>
                    <button id="send-btn" onclick="generateSite()" class="bg-blue-600 hover:bg-blue-700 text-white w-11 h-11 rounded-lg flex items-center justify-center shrink-0 transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </footer>
        </main>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-xl w-full max-w-md border border-gray-700 shadow-2xl flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-700 shrink-0">
                <h2 class="text-xl font-bold text-white">Settings</h2>
                <button onclick="toggleSettings(false)" class="text-gray-400 hover:text-white"><i class="fas fa-times text-lg"></i></button>
            </div>
            
            <div class="p-5 space-y-4 flex-1 overflow-y-auto">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">API URL Endpoint</label>
                    <input type="text" id="setting-api-url" class="w-full bg-gray-900 border border-gray-600 rounded p-2.5 text-white focus:border-blue-500 outline-none font-mono text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">API Key</label>
                    <input type="password" id="setting-api-key" class="w-full bg-gray-900 border border-gray-600 rounded p-2.5 text-white focus:border-blue-500 outline-none font-mono text-sm" placeholder="sk-or-v1-...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Model ID</label>
                    <input type="text" id="setting-model-id" class="w-full bg-gray-900 border border-gray-600 rounded p-2.5 text-white focus:border-blue-500 outline-none font-mono text-sm">
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-700 bg-gray-900 rounded-b-xl flex justify-end shrink-0">
                <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium transition shadow-lg">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // System Prompt strictly forcing HTML
        const SYSTEM_PROMPT = `You are an expert web developer. Output ONLY raw, functional HTML code inside a single file. 
Include inline CSS or Tailwind CSS via CDN (<script src="https://cdn.tailwindcss.com"><\/script>). 
Include FontAwesome if icons are needed. 
Do NOT include markdown formatting like \`\`\`html. 
Do NOT include explanations. Just the raw valid HTML code.`;

        // Default Configs
        const DEFAULT_API_URL = "https://openrouter.ai/api/v1/chat/completions"; // CRITICAL FIX 1
        const DEFAULT_MODEL = "deepseek/deepseek-r1:free";

        // State
        let settings = { apiUrl: DEFAULT_API_URL, apiKey: "", modelId: DEFAULT_MODEL };
        let projects = [];
        let currentProjectId = null;
        let currentMode = 'preview'; // 'preview' or 'code'

        // Initialization
        window.onload = () => {
            loadFromStorage();
            if (projects.length === 0) createNewProject();
            renderProjectList();
            renderCurrentProject();
        };

        // UI Interactions
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                generateSite();
            }
        }

        function switchTab(mode) {
            currentMode = mode;
            const btnPreview = document.getElementById('btn-preview');
            const btnCode = document.getElementById('btn-code');
            const iframe = document.getElementById('preview-frame');
            const codeView = document.getElementById('code-view');

            if (mode === 'preview') {
                btnPreview.className = "px-4 py-1.5 rounded-md text-sm font-medium bg-gray-600 text-white shadow transition";
                btnCode.className = "px-4 py-1.5 rounded-md text-sm font-medium text-gray-400 hover:text-white transition";
                iframe.classList.remove('hidden');
                codeView.classList.add('hidden');
                
                // Refresh iframe with latest code
                const activeProj = getActiveProject();
                if (activeProj) updateIframe(activeProj.html);
            } else {
                btnCode.className = "px-4 py-1.5 rounded-md text-sm font-medium bg-gray-600 text-white shadow transition";
                btnPreview.className = "px-4 py-1.5 rounded-md text-sm font-medium text-gray-400 hover:text-white transition";
                codeView.classList.remove('hidden');
                iframe.classList.add('hidden');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('hidden');
            overlay.classList.toggle('hidden');
        }

        // Settings Management
        function toggleSettings(show) {
            const modal = document.getElementById('settings-modal');
            if (show) {
                document.getElementById('setting-api-url').value = settings.apiUrl || DEFAULT_API_URL;
                document.getElementById('setting-api-key').value = settings.apiKey;
                document.getElementById('setting-model-id').value = settings.modelId || DEFAULT_MODEL;
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function saveSettings() {
            settings.apiUrl = document.getElementById('setting-api-url').value.trim() || DEFAULT_API_URL;
            settings.apiKey = document.getElementById('setting-api-key').value.trim();
            settings.modelId = document.getElementById('setting-model-id').value.trim() || DEFAULT_MODEL;
            
            localStorage.setItem('ai_builder_settings', JSON.stringify(settings));
            toggleSettings(false);
        }

        // Project Management
        function getActiveProject() {
            return projects.find(p => p.id === currentProjectId);
        }

        function createNewProject() {
            const newId = Date.now().toString();
            const newProj = {
                id: newId,
                name: `Project ${projects.length + 1}`,
                html: '<div class="h-full flex items-center justify-center bg-gray-100 text-gray-400 font-sans">Start describing your website below...</div>',
                history: []
            };
            projects.unshift(newProj);
            currentProjectId = newId;
            saveProjects();
            renderProjectList();
            renderCurrentProject();
            if(window.innerWidth < 768) toggleSidebar(); // auto-close sidebar on mobile
        }

        function selectProject(id) {
            currentProjectId = id;
            saveProjects();
            renderProjectList();
            renderCurrentProject();
            if(window.innerWidth < 768) toggleSidebar();
        }

        function deleteProject(id, e) {
            e.stopPropagation();
            if(projects.length <= 1) return alert("Cannot delete the last project.");
            projects = projects.filter(p => p.id !== id);
            if(currentProjectId === id) currentProjectId = projects[0].id;
            saveProjects();
            renderProjectList();
            renderCurrentProject();
        }

        // Rendering Data
        function renderProjectList() {
            const list = document.getElementById('project-list');
            list.innerHTML = '';
            projects.forEach(p => {
                const isActive = p.id === currentProjectId;
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-3 rounded-lg cursor-pointer transition ${isActive ? 'bg-gray-800 border border-gray-600' : 'hover:bg-gray-800 border border-transparent'}`;
                div.onclick = () => selectProject(p.id);
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="fas fa-code text-${isActive ? 'blue-400' : 'gray-500'}"></i>
                        <span class="text-sm truncate ${isActive ? 'text-white font-medium' : 'text-gray-400'}">${p.name}</span>
                    </div>
                    <button onclick="deleteProject('${p.id}', event)" class="text-gray-600 hover:text-red-400 hidden group-hover:block transition">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function renderCurrentProject() {
            const activeProj = getActiveProject();
            if (!activeProj) return;
            
            document.getElementById('code-view').value = activeProj.html;
            updateIframe(activeProj.html);
        }

        function updateIframe(htmlContent) {
            const iframe = document.getElementById('preview-frame');
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            iframe.onload = () => URL.revokeObjectURL(url); // Cleanup memory
            iframe.src = url;
        }

        function updateFromCode(newHtml) {
            const activeProj = getActiveProject();
            if(activeProj) {
                activeProj.html = newHtml;
                saveProjects();
                // update iframe live if preview tab gets clicked later
            }
        }

        // API & Generation Logic
        async function generateSite() {
            const inputEl = document.getElementById('prompt-input');
            const prompt = inputEl.value.trim();
            if (!prompt) return;

            if (!settings.apiKey) {
                alert("Please add your API Key in Settings first.");
                toggleSettings(true);
                return;
            }

            const activeProj = getActiveProject();
            activeProj.history.push({ role: "user", content: prompt });
            
            // Name the project based on first prompt if it's default
            if(activeProj.name.startsWith("Project ") && activeProj.history.length === 1) {
                activeProj.name = prompt.substring(0, 20) + (prompt.length > 20 ? "..." : "");
                renderProjectList();
            }

            inputEl.value = '';
            inputEl.style.height = 'auto'; // reset height
            document.getElementById('loader').classList.remove('hidden');

            try {
                const response = await fetch(settings.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${settings.apiKey}`
                    },
                    body: JSON.stringify({
                        model: settings.modelId,
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            ...activeProj.history
                        ],
                        temperature: 0.2 // low temp for coding
                    })
                });

                // CRITICAL FIX 2: Anti-Crash JSON Logic
                const text = await response.text();
                if (!response.ok) {
                    alert("API Error (" + response.status + "): \n" + text);
                    document.getElementById('loader').classList.add('hidden');
                    activeProj.history.pop(); // remove failed prompt
                    return; // STOP execution
                }

                // Only parse AFTER validation
                const data = JSON.parse(text);
                const reply = data.choices[0].message.content;

                // Save to history
                activeProj.history.push({ role: "assistant", content: reply });

                // Clean the output (Remove <think> tags from DeepSeek and markdown wrappers)
                const cleanHtml = extractCleanHTML(reply);
                activeProj.html = cleanHtml;
                
                saveProjects();
                renderCurrentProject();

            } catch (error) {
                alert("Network or parsing error: " + error.message);
                activeProj.history.pop();
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function extractCleanHTML(raw) {
            // Strip DeepSeek-R1 <think> blocks
            let output = raw.replace(/<think>[\s\S]*?<\/think>/gi, '');
            
            // Look for ```html ... ``` blocks
            const match = output.match(/```(?:html)?\s*([\s\S]*?)```/i);
            if (match) return match[1].trim();
            
            return output.trim();
        }

        // Utilities
        function downloadCode() {
            const activeProj = getActiveProject();
            if(!activeProj) return;
            
            const blob = new Blob([activeProj.html], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `index_${activeProj.id}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function loadFromStorage() {
            try {
                const savedSettings = localStorage.getItem('ai_builder_settings');
                if (savedSettings) settings = { ...settings, ...JSON.parse(savedSettings) };
                
                // Enforce Critical Fix 1 even if old settings exist
                if(!settings.apiUrl) settings.apiUrl = DEFAULT_API_URL;

                const savedProjects = localStorage.getItem('ai_builder_projects');
                if (savedProjects) projects = JSON.parse(savedProjects);

                const savedCurrent = localStorage.getItem('ai_builder_current');
                if (savedCurrent) currentProjectId = savedCurrent;
            } catch (e) {
                console.error("Storage load failed", e);
            }
        }

        function saveProjects() {
            localStorage.setItem('ai_builder_projects', JSON.stringify(projects));
            if(currentProjectId) localStorage.setItem('ai_builder_current', currentProjectId);
        }
    </script>
</body>
</html>
